# 第 15 回 API 開発 2021/06/20 14:00-17:00

[https://javajo.doorkeeper.jp/events/122100](https://javajo.doorkeeper.jp/events/122100)

## 議事録作成者
yuki (N)

## 参加者(敬称略)
- aya
- ellie
- maaya
- miyuki
- yuki (K)

## 議題にしたいこと or 前回の next action

★アイスブレイクの「今月のお題」は議事録作成者が決定する方向になりました！

- アイスブレイク
  - 名前
  - エンジニア的近況報告
  - ワクチンが行き渡って外出しやすくなったら最初にやりたいこと
- 前回のおさらい
- 今日やること
  - レスポンスデータが空の時空のレスポンスボディを返すかエラーを返すか決める(今回未消化)
  - 今回書いたテストを書ききる(JSON内の全項目を確認する)
  - DBを用意する(誰かがデータ設計の叩きを用意できたらしておく…)
 
## 議事内容
### DB設計
- 詳細はMiroを参照
  - PlantUMLでのER図作成は細かすぎるので今回はMiroでラフに  

### 各テーブルの詳細設計
#### 会員情報(saketomo)
- emailは暗号化しておきたい．VARCHAR型
- imageは最終的にENUMではなくなることを見越して現時点からVARCHARにしておく
- 退会したユーザのレビューもIDを`退会済み`などにして表示させたい
  - 物理削除だと退会したユーザに紐づいたレビューも削除される
  - 外部キーは設定しない(リレーションを張らない)
  - 退会時にはレビューのsaketomoIDをデフォルトIDに即座に置換する
    - 規模が大きくなったら夜間バッチでアップデート(一時的に論理削除する機能が必要)を検討すること
　  
#### 口コミ情報(review)
- saketomoはsaketomoのID. 型はUUID.
  - 会員情報へリレーションは張らない 
- ユーザに口コミ情報のupdateはさせないが，機能拡張に備えて`updatedAt`を一応内部では持たせておく
      
#### 酒情報(sake)
- IDはUUIDにすべきか？　-> **UUIDでいきましょう**
  - 一般的に連番IDはセキュリティ的によろしくないが，酒情報は公開前提なので盗まれて困る情報ではない
  - オートインクリメントだとCREATEのあとにアプリからSELECTをかける必要があり，アプリでUUIDを生成してDBに渡す方が便利
  
##### brewery
- id(UUID)を持たせる
- 現時点ではマスターでUPDATEする
- 海外のbreweryも考慮してregionテーブルを導入
  - 日本国内は都道府県レベル(id:1-47)，国外は国レベル(id:48-)でレコードを割り振る
  - countryが`JP`の場合のみprefectureが存在する
  - countryとprefectureはそれぞれ別途マスターテーブルを用意する
    - prefectureには日本の各都道府県と海外のレコードを用意(全48レコード)
      
##### taste
- tasteのマスタテーブルを作成する
  - 最終的にハッシュタグでの検索や補完をやりたい
  - ハッシュタグが新しく生成されるごとにマスタに追加
  - とりあえず表記ブレ(ex.「スッキリ」「すっきり」)は考えずに完全一致で検索
   
- 酒情報とtasteのマッピングテーブルを作成する
  - sake.idとtaste.idの複合キー
  - 比較検討したアイディア
    1. sake情報に直接JSON型(PostgreSQL独自)で持つ
      - JSON型の検索はORマッパーではなくクエリのベタ書きになりそう
    2. sake情報に直接リスト型で持つ
      - 検索時にLIKEを多用することになり，パフォーマンス面を懸念

#### その他
DB内で複数形を意味する's'は使用しない

### DBの管理情報
(念のため，ここでは詳細を伏せておきます)
- DB名  
- ユーザ名  
- 各ユーザに対するユーザ権限: r/w  
- 管理ユーザ  
- 管理ユーザ権限: full (管理ユーザ権限が必要な操作は画面を共有しながら行う)   

## 今回の成果
- DB設計完了!

## next action(タスク洗い出し)
- DDLスキーマの準備(miyukiさん)
  - 次回はこのスキーマをベースにDBを作成するところからスタート

- 前回からの持ち越し
  - レスポンスデータが空の時空のレスポンスボディを返すかエラーを返すか決める
  - 今回書いたテストを書ききる(JSON内の全項目を確認する)

## 議事録作成者の感想ひとこと
- SQLをまともに使ったことがないので勉強します...
- 7月のお題: 2021年夏のマイブームはなんですか？
